<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Pattern to load JS libraries asynchronously">
  <meta name="robots" content="index,follow">


  <title>
    
      Pattern to load JS libraries asynchronously &middot; Gautam Chandra
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Gautam Chandra" href="/atom.xml">

  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-65271393-1', 'auto');
    ga('send', 'pageview');

  </script>

  <!-- Go to www.addthis.com/dashboard to customize your tools -->
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55aa404d45442acb" async="async"></script>

</head>


  <body>

    <h3 class="masthead-title">

      
        &nbsp;&nbsp;&nbsp;
        <span class="nav-bar"><a href="/">About</a></span>
      
        &nbsp;&nbsp;&nbsp;
        <span class="nav-bar"><a href="/blog">Blog</a></span>
      
        &nbsp;&nbsp;&nbsp;
        <span class="nav-bar"><a href="//github.com/dhunnapotha">Github</a></span>
      
    </h3>  

    <div class="container content">

      <main>
        <article class="post">
  <h1 class="post-title">Pattern to load JS libraries asynchronously</h1>
  <time datetime="2015-07-17T00:00:00+05:30" class="post-date">17 Jul 2015</time>
  <p>Sometimes, you want the external js files to be loaded asynchronously such that their loading time doesn’t impact the user experience of your site. For example, when you want to integrate google-analytics.</p>

<p>Which means, you will have to wait for the js file to be loaded to use any of the functions provided in the js library. There is a nice pattern which lets you bypass this.</p>

<p>Below is the snippet Google Analytics give you to insert in your pages.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//https://developers.google.com/analytics/devguides/collection/analyticsjs/advanced</span>
 
<span class="cm">/**</span>
<span class="cm"> * Creates a temporary global ga object and loads analy  tics.js.</span>
<span class="cm"> * Paramenters o, a, and m are all used internally.  They could have been declared using &#39;var&#39;,</span>
<span class="cm"> * instead they are declared as parameters to save 4 bytes (&#39;var &#39;).</span>
<span class="cm"> *</span>
<span class="cm"> * @param {Window}      i The global context object.</span>
<span class="cm"> * @param {Document}    s The DOM document object.</span>
<span class="cm"> * @param {string}      o Must be &#39;script&#39;.</span>
<span class="cm"> * @param {string}      g URL of the analytics.js script. Inherits protocol from page.</span>
<span class="cm"> * @param {string}      r Global name of analytics object.  Defaults to &#39;ga&#39;.</span>
<span class="cm"> * @param {DOMElement?} a Async script tag.</span>
<span class="cm"> * @param {DOMElement?} m First script tag in document.</span>
<span class="cm"> */</span>
<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">m</span><span class="p">){</span>
  <span class="nx">i</span><span class="p">[</span><span class="s1">&#39;GoogleAnalyticsObject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span> <span class="c1">// Acts as a pointer to support renaming.</span>
 
  <span class="c1">// Creates an initial ga() function.  The queued commands will be executed once analytics.js loads.</span>
  <span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">(</span><span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">q</span> <span class="o">=</span> <span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">q</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)</span>
  <span class="p">},</span>
 
  <span class="c1">// Sets the time (as an integer) this tag was executed.  Used for timing hits.</span>
  <span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
 
  <span class="c1">// Insert the script tag asynchronously.  Inserts above current tag to prevent blocking in</span>
  <span class="c1">// addition to using the async attribute.</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span>
  <span class="nx">m</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">o</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">g</span><span class="p">;</span>
  <span class="nx">m</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
<span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;//www.google-analytics.com/analytics.js&#39;</span><span class="p">,</span> <span class="s1">&#39;ga&#39;</span><span class="p">);</span>
 
<span class="nx">ga</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;UA-XXXX-Y&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">);</span> <span class="c1">// Creates the tracker with default parameters.</span>
<span class="nx">ga</span><span class="p">(</span><span class="s1">&#39;send&#39;</span><span class="p">,</span> <span class="s1">&#39;pageview&#39;</span><span class="p">);</span>            <span class="c1">// Sends a pageview hit.</span>
 
<span class="c1">// The other part is in https://gist.github.com/dhunnapotha/5c46a93eeec8239a9e68</span></code></pre></div>

<p>You should notice 3 important points here:</p>

<ul>
  <li>The js file is loaded asynchronously with .sync = 1 and is being inserted into the DOM</li>
  <li>Until the file is loaded asynchronously, all the calls to ga (for eg: ga(create..)) will push into window[‘ga’].q</li>
  <li>The handler, in this case, ‘ga’ is being stored in window[‘GoogleAnalyticsObject’]</li>
</ul>

<p>Once the file is loaded,</p>

<ul>
  <li>We need to flush out all the entries pushed into window[‘ga’].q, which is fairly straightforward.</li>
  <li>And then, assign the loaded library to window[window[‘GoogleAnalyticsObject’]] such that all further calls to ga() will execute the functions defined in the library.</li>
</ul>

<p>A sample snippet can look like this</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="s1">&#39;GoogleAnalyticsObject&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;ga&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">queue</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">handler</span><span class="p">])</span>
    <span class="nx">queue</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="nx">handler</span><span class="p">].</span><span class="nx">q</span><span class="p">;</span>
 
  <span class="nx">queue</span> <span class="o">=</span> <span class="nx">queue</span> <span class="o">||</span> <span class="p">[];</span>
 
  <span class="k">while</span><span class="p">(</span><span class="nx">ele</span> <span class="o">=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">())</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ele</span><span class="p">);</span>
    <span class="nx">GoogleAnalytics</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">GoogleAnalytics</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nb">window</span><span class="p">[</span><span class="nx">handler</span><span class="p">]</span> <span class="o">=</span> <span class="nx">GoogleAnalytics</span><span class="p">;</span>
<span class="p">})();</span></code></pre></div>


</article>


<aside class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/07/20/Setting-up-custom-domain-blog-with-jekyll/">
            Setting up a custom domain website with Jekyll
            <small><time datetime="2015-07-20T00:00:00+05:30">20 Jul 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/07/20/Setting-up-blog-with-free-custom-domain/">
            Setting up a free blog or a website with custom domain!
            <small><time datetime="2015-07-20T00:00:00+05:30">20 Jul 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/07/17/uglifying-file/">
            Uglifying a file
            <small><time datetime="2015-07-17T00:00:00+05:30">17 Jul 2015</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2015-07-25T06:50:27+05:30">2015</time>. All rights reserved.
        </small>
      </footer>
    </div>

  </body>
</html>
